#!/usr/bin/env ruby
# @author Matthieu Gourv√©nec <matthieu.gourvenec@gmail.com>

require_relative '../lib/fgi'

argv = ARGV

# ----------------------------- #
#          FGI CMD DOC          #
# ----------------------------- #

options = {}
options_parser = OptionParser.new do |fgi|
  fgi.banner = 'Usage: fgi COMMAND [OPTION]'
  fgi.separator ''
  fgi.separator 'Commands'
  fgi.separator '    config              : run the fgi configurator.'
  fgi.separator '    token  [TOKEN]      : define the new user token.'
  fgi.separator '    new    [ISSUE_NAME] : create the issue with the given name.'
  fgi.separator '    ... more comming soon ...'
  fgi.separator ''
  fgi.separator 'Options'

  fgi.on('-e', '--estimate [ESTIMATION]', 'How many time do you think you will spend on this issue ? (example: 1d13h37m05s)') do |estimate|
    options[:estimate] = estimate
  end

  fgi.on('-h', '--help', 'Display the FGI manual') do
    puts options_parser
  end
end
options_parser.parse!

# ---------------------------- #
#          DISPATCHER          #
# ---------------------------- #

def get_full_issue_title(argv)
  return nil if argv[1].nil?
  length = argv.length
  argv[1..length].join(' ')
end

case argv[0]
when 'config'
  Fgi::Configuration.new_config
when 'new'
  Fgi.configured?
  if argv[1].start_with?('-')
    puts %q(You can't begin your issue's title with '-')
    exit!
  end
  title = get_full_issue_title(argv)
  Fgi::GitService.create_issue(title: title, estimation: options[:estimate])
when 'token'
  Fgi.configured?
  Fgi::Tokens.add_token(argv[1])
else
  puts options_parser
end
